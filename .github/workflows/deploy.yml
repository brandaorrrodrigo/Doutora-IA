name: Deploy to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        id: deploy
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          ENV: ${{ github.event.inputs.environment || 'production' }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            set -e

            # Navigate to deployment directory
            cd ${DEPLOY_PATH}

            # Pull latest code
            git fetch origin
            git checkout ${GITHUB_REF_NAME}
            git pull origin ${GITHUB_REF_NAME}

            # Update environment variables
            cp .env.${ENV} .env

            # Pull latest Docker images
            docker-compose pull

            # Run database migrations
            docker-compose run --rm api alembic upgrade head

            # Restart services with zero downtime
            docker-compose up -d --no-deps --build api web-app

            # Health check
            sleep 10
            curl -f http://localhost:8000/health || exit 1

            echo "Deployment successful!"
          ENDSSH

          echo "url=https://doutora-ia.com" >> $GITHUB_OUTPUT

      - name: Notify deployment success
        if: success()
        run: |
          echo "Deployment to ${{ github.event.inputs.environment || 'production' }} successful!"

      - name: Rollback on failure
        if: failure()
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            set -e
            cd ${DEPLOY_PATH}

            echo "Deployment failed, rolling back..."

            # Rollback to previous version
            docker-compose down
            git reset --hard HEAD~1
            docker-compose up -d

            echo "Rollback complete"
          ENDSSH

  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests pytest

      - name: Run smoke tests
        env:
          API_URL: ${{ secrets.PRODUCTION_API_URL || 'https://api.doutora-ia.com' }}
        run: |
          python << 'ENDPYTHON'
          import requests
          import sys

          # Health check
          print("Testing health endpoint...")
          r = requests.get(f"{os.getenv('API_URL')}/health", timeout=10)
          assert r.status_code == 200
          assert r.json()["status"] == "healthy"
          print("✓ Health check passed")

          # Search endpoint (basic)
          print("Testing search endpoint...")
          r = requests.post(
              f"{os.getenv('API_URL')}/search",
              json={"query": "CDC", "filtros": {}, "limit": 5},
              timeout=30
          )
          assert r.status_code == 200
          print("✓ Search endpoint passed")

          print("\nAll smoke tests passed!")
          ENDPYTHON

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: always()

    steps:
      - name: Notify on Slack
        if: ${{ secrets.SLACK_WEBHOOK_URL }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "Deployment ${{ needs.deploy.result }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Deployment to *${{ github.event.inputs.environment || 'production' }}* ${{ needs.deploy.result }}\n*Tag:* ${{ github.ref_name }}\n*Status:* ${{ needs.deploy.result }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v') && needs.deploy.result == 'success'
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          draft: false
          prerelease: false

version: '3.8'

services:
  # ============================================================
  # vLLM - DESATIVADO (usando Ollama no host via port 11434)
  # ============================================================
  # vllm:
  #   image: vllm/vllm-openai:latest
  #   container_name: doutora-vllm
  #   command:
  #     - --model
  #     - meta-llama/Meta-Llama-3-8B-Instruct
  #     - --dtype
  #     - auto
  #     - --api-key
  #     - ${VLLM_API_KEY:-token-xyz}
  #     - --served-model-name
  #     - llama3
  #     - --max-model-len
  #     - "4096"
  #   environment:
  #     - HF_TOKEN=${HF_TOKEN}
  #   ports:
  #     - "8000:8000"
  #   volumes:
  #     - vllm_cache:/root/.cache/huggingface
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             count: 1
  #             capabilities: [gpu]
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

  # Qdrant - Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: doutora-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "bash -c ':> /dev/tcp/localhost/6333' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL - Relational Database
  db:
    image: postgres:16-alpine
    container_name: doutora-db
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-doutora}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # FastAPI - Main API
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: doutora-api
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-doutora}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - VLLM_BASE_URL=http://host.docker.internal:11434/v1
      - VLLM_API_KEY=ollama
      - VLLM_MODEL=${VLLM_MODEL:-llama3.1:8b}
      - EMBEDDING_MODEL=intfloat/multilingual-e5-large
      - REDIS_URL=redis://redis:6379
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - MERCADO_PAGO_ACCESS_TOKEN=${MERCADO_PAGO_ACCESS_TOKEN}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - FRONTEND_URL=${FRONTEND_URL:-https://www.doutoraia.com}
      - API_HOST=${API_HOST:-https://api.doutoraia.com}
      - BASE_URL=${BASE_URL:-http://localhost:3000}
      - CORPUS_UPDATE_DATE=${CORPUS_UPDATE_DATE:-2025-12-09}
    ports:
      - "8080:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./api:/app
      - ./data:/data
      - reports_storage:/reports
    depends_on:
      - db
      - qdrant
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis - Queue and Cache
  redis:
    image: redis:7-alpine
    container_name: doutora-redis
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Worker - Background Tasks
  worker:
    build:
      context: ./worker
      dockerfile: Dockerfile
    container_name: doutora-worker
    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-doutora}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - REDIS_URL=redis://redis:6379
      - EMBEDDING_MODEL=intfloat/multilingual-e5-large
    volumes:
      - ./worker:/app
      - ./data:/data
      - reports_storage:/reports
    depends_on:
      - db
      - qdrant
      - redis
    restart: unless-stopped

  # ============================================================
  # Web - DESATIVADO (frontend hospedado no Vercel: www.doutoraia.com)
  # ============================================================
  # web:
  #   build:
  #     context: ./web
  #     dockerfile: Dockerfile
  #   container_name: doutora-web
  #   environment:
  #     - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8080}
  #     - NEXT_PUBLIC_MERCADO_PAGO_PUBLIC_KEY=${NEXT_PUBLIC_MERCADO_PAGO_PUBLIC_KEY}
  #   ports:
  #     - "3000:3000"
  #   volumes:
  #     - ./web:/app
  #     - /app/node_modules
  #     - /app/.next
  #   depends_on:
  #     - api
  #   restart: unless-stopped

volumes:
  qdrant_storage:
  postgres_data:
  redis_data:
  reports_storage:
